#include "THISDUST.H"
#include "MATH3D.H"


// decompiled code
// original method signature: 
// void /*$ra*/ MATH3D_Sort3VectorCoords(long *a /*$a0*/, long *b /*$a1*/, long *c /*$a2*/)
 // line 220, offset 0x800399c8
	/* begin block 1 */
		// Start line: 222
		// Start offset: 0x800399C8
		// Variables:
	// 		long a1; // $t0
	// 		long b1; // $v1
	// 		long c1; // $a3
	/* end block 1 */
	// End offset: 0x80039A44
	// End Line: 256

	/* begin block 2 */
		// Start line: 371
	/* end block 2 */
	// End Line: 372

	/* begin block 3 */
		// Start line: 437
	/* end block 3 */
	// End Line: 438

	/* begin block 4 */
		// Start line: 372
	/* end block 4 */
	// End Line: 373

/* File: C:\kain2\game\MATH3D.C */

void MATH3D_Sort3VectorCoords(long *a,long *b,long *c)

{
  int iVar1;
  int iVar2;
  int iVar3;
  
  iVar3 = *a;
  iVar1 = *b;
  iVar2 = *c;
  if (iVar3 < iVar1) {
    if (iVar2 < iVar3) {
      *c = iVar1;
      *b = iVar3;
      *a = iVar2;
      return;
    }
    if (iVar2 < iVar1) {
      *c = iVar1;
      *b = iVar2;
      return;
    }
  }
  else {
    if (iVar2 < iVar1) {
      *a = iVar2;
      *c = iVar3;
      return;
    }
    if (iVar2 < iVar3) {
      *a = iVar1;
      *b = iVar2;
      *c = iVar3;
      return;
    }
    *a = iVar1;
    *b = iVar3;
  }
  return;
}



// decompiled code
// original method signature: 
// long /*$ra*/ MATH3D_LengthXYZ(long x /*$a0*/, long y /*$a1*/, long z /*$a2*/)
 // line 258, offset 0x80039a4c
	/* begin block 1 */
		// Start line: 260
		// Start offset: 0x80039A4C
		// Variables:
	// 		long t; // $v0
	/* end block 1 */
	// End offset: 0x80039B14
	// End Line: 309

	/* begin block 2 */
		// Start line: 447
	/* end block 2 */
	// End Line: 448

	/* begin block 3 */
		// Start line: 448
	/* end block 3 */
	// End Line: 449

	/* begin block 4 */
		// Start line: 449
	/* end block 4 */
	// End Line: 450

/* File: C:\kain2\game\MATH3D.C */

long MATH3D_LengthXYZ(long x,long y,long z)

{
  int iVar1;
  int iVar2;
  int iVar3;
  int iVar4;
  
  if (x < 0) {
    x = -x;
  }
  if (y < 0) {
    y = -y;
  }
  if (z < 0) {
    z = -z;
  }
  iVar1 = x;
  if (x < y) {
    iVar1 = y;
    y = x;
  }
  iVar2 = z;
  iVar3 = y;
  iVar4 = iVar1;
  if ((y <= z) && (iVar2 = y, iVar3 = iVar1, iVar4 = z, z < iVar1)) {
    iVar3 = z;
    iVar4 = iVar1;
  }
  iVar1 = iVar4 * 0x1e + iVar3 * 0xc + iVar2 * 9;
  if (iVar1 < 0) {
    iVar1 = iVar1 + 0x1f;
  }
  return iVar1 >> 5;
}



// decompiled code
// original method signature: 
// long /*$ra*/ MATH3D_LengthXY(long x /*$a0*/, long y /*$a1*/)
 // line 312, offset 0x80039b1c
	/* begin block 1 */
		// Start line: 555
	/* end block 1 */
	// End Line: 556

	/* begin block 2 */
		// Start line: 556
	/* end block 2 */
	// End Line: 557

/* File: C:\kain2\game\MATH3D.C */

long MATH3D_LengthXY(long x,long y)

{
  int iVar1;
  uint uVar2;
  
  if (x < 0) {
    x = -x;
  }
  if (y < 0) {
    y = -y;
  }
  if (y < x) {
    uVar2 = x ^ y;
    y = y ^ uVar2;
    x = uVar2 ^ y;
  }
  iVar1 = y * 0x1e + x * 0xc;
  if (iVar1 < 0) {
    iVar1 = iVar1 + 0x1f;
  }
  return iVar1 >> 5;
}



// decompiled code
// original method signature: 
// void /*$ra*/ MATH3D_Normalize(struct _Normal *normal /*$s0*/)
 // line 328, offset 0x80039b7c
	/* begin block 1 */
		// Start line: 329
		// Start offset: 0x80039B7C
		// Variables:
	// 		long length; // $a1
	/* end block 1 */
	// End offset: 0x80039BFC
	// End Line: 345

	/* begin block 2 */
		// Start line: 653
	/* end block 2 */
	// End Line: 654

/* File: C:\kain2\game\MATH3D.C */

void MATH3D_Normalize(_Normal *normal)

{
  long lVar1;
  
  lVar1 = MATH3D_LengthXYZ((int)normal->x << 2,(int)normal->y << 2,(int)normal->z << 2);
  if (lVar1 != 0) {
    normal->x = (short)(((int)normal->x << 0xe) / lVar1);
    normal->y = (short)(((int)normal->y << 0xe) / lVar1);
    normal->z = (short)(((int)normal->z << 0xe) / lVar1);
  }
  return;
}



// decompiled code
// original method signature: 
// short /*$ra*/ MATH3D_FastAtan2(long y /*$a0*/, long x /*$a1*/)
 // line 349, offset 0x80039c0c
	/* begin block 1 */
		// Start line: 351
		// Start offset: 0x80039C0C
		// Variables:
	// 		long ax; // $a3
	// 		long ay; // $a2
	/* end block 1 */
	// End offset: 0x80039D20
	// End Line: 401

	/* begin block 2 */
		// Start line: 619
	/* end block 2 */
	// End Line: 620

	/* begin block 3 */
		// Start line: 620
	/* end block 3 */
	// End Line: 621

	/* begin block 4 */
		// Start line: 623
	/* end block 4 */
	// End Line: 624

/* File: C:\kain2\game\MATH3D.C */

short MATH3D_FastAtan2(long y,long x)

{
  short sVar1;
  int iVar2;
  int iVar3;
  short sVar4;
  
  if (x == 0) {
    x = 1;
  }
  if (y != 0) {
    iVar3 = x;
    if (x < 0) {
      iVar3 = -x;
    }
    iVar2 = y;
    if (y < 0) {
      iVar2 = -y;
    }
    if (x < 1) {
      if (y < 1) {
        if (iVar2 < iVar3) {
          return (short)((uint)(((iVar2 << 9) / iVar3 + 0x800) * 0x10000) >> 0x10);
        }
        sVar4 = (short)((iVar3 << 9) / iVar2);
        sVar1 = 0xc00;
      }
      else {
        if (iVar3 < iVar2) {
          return (short)((iVar3 << 9) / iVar2) + 0x400;
        }
        sVar4 = (short)((iVar2 << 9) / iVar3);
        sVar1 = 0x800;
      }
    }
    else {
      if (y < 1) {
        if (iVar3 <= iVar2) {
          return (short)((iVar3 << 9) / iVar2) + 0xc00;
        }
        sVar4 = (short)((iVar2 << 9) / iVar3);
        sVar1 = 0x1000;
      }
      else {
        if (iVar2 <= iVar3) {
          return (short)((iVar2 << 9) / iVar3);
        }
        sVar4 = (short)((iVar3 << 9) / iVar2);
        sVar1 = 0x400;
      }
    }
    return sVar1 - sVar4;
  }
  return (short)((ushort)(x < 1) << 0xb);
}



// decompiled code
// original method signature: 
// long /*$ra*/ MATH3D_FastSqrt(long square /*$a0*/)
 // line 456, offset 0x80039d28
	/* begin block 1 */
		// Start line: 458
		// Start offset: 0x80039D28

		/* begin block 1.1 */
			// Start line: 458
			// Start offset: 0x80039D30
			// Variables:
		// 		unsigned long result; // $t0
		// 		long remainder; // $v0
		// 		long mask; // $a1
		// 		long shift; // $a2
		// 		long mask_squared; // $a3
		// 		long result_shift; // $v1
		/* end block 1.1 */
		// End offset: 0x80039E00
		// End Line: 504
	/* end block 1 */
	// End offset: 0x80039E00
	// End Line: 506

	/* begin block 2 */
		// Start line: 835
	/* end block 2 */
	// End Line: 836

	/* begin block 3 */
		// Start line: 836
	/* end block 3 */
	// End Line: 837

/* File: C:\kain2\game\MATH3D.C */

long MATH3D_FastSqrt(long square)

{
  int iVar1;
  int iVar2;
  uint uVar3;
  int iVar4;
  uint uVar5;
  int iVar6;
  uint uVar7;
  
  iVar4 = 0x1f;
  if (square == 0) {
    return 0;
  }
  uVar3 = 0x80000000;
  if (-1 < square) {
    do {
      uVar3 = (int)uVar3 >> 1;
      iVar4 = iVar4 + -1;
    } while ((uVar3 & square) == 0);
  }
  uVar5 = iVar4 >> 1;
  uVar3 = 1 << (uVar5 + 6 & 0x1f);
  iVar4 = 1 << ((uVar5 & 0xf) << 1);
  uVar7 = uVar3;
  iVar6 = iVar4;
  iVar2 = square - iVar4;
  while (uVar5 = uVar5 - 1, uVar5 != 0xffffffff) {
    iVar6 = iVar6 >> 2;
    iVar1 = iVar2 - (iVar4 + iVar6);
    uVar3 = (int)uVar3 >> 1;
    iVar4 = iVar4 >> 1;
    if (-1 < iVar1) {
      iVar4 = iVar4 + iVar6;
      uVar7 = uVar7 | uVar3;
      iVar2 = iVar1;
    }
  }
  iVar4 = iVar4 << 0xc;
  iVar1 = 0x1000;
  iVar6 = iVar2 << 0xc;
  while( true ) {
    uVar3 = (int)uVar3 >> 1;
    iVar1 = iVar1 >> 2;
    if (uVar3 == 0) break;
    iVar2 = iVar6 - (iVar4 + iVar1);
    iVar4 = iVar4 >> 1;
    if (-1 < iVar2) {
      iVar4 = iVar4 + iVar1;
      uVar7 = uVar7 | uVar3;
      iVar6 = iVar2;
    }
  }
  return uVar7;
}



// decompiled code
// original method signature: 
// long /*$ra*/ MATH3D_FastSqrt0(long square /*$a0*/)
 // line 511, offset 0x80039e08
	/* begin block 1 */
		// Start line: 513
		// Start offset: 0x80039E08

		/* begin block 1.1 */
			// Start line: 513
			// Start offset: 0x80039E10
			// Variables:
		// 		unsigned long result; // $t0
		// 		long remainder; // $v0
		// 		long mask; // $a2
		// 		long shift; // $a1
		// 		long mask_squared; // $a3
		// 		long result_shift; // $v1
		/* end block 1.1 */
		// End offset: 0x80039E90
		// End Line: 546
	/* end block 1 */
	// End offset: 0x80039E90
	// End Line: 548

	/* begin block 2 */
		// Start line: 945
	/* end block 2 */
	// End Line: 946

	/* begin block 3 */
		// Start line: 946
	/* end block 3 */
	// End Line: 947

/* File: C:\kain2\game\MATH3D.C */

long MATH3D_FastSqrt0(long square)

{
  int iVar1;
  int iVar2;
  int iVar3;
  int iVar4;
  uint uVar5;
  uint uVar6;
  uint uVar7;
  
  iVar4 = 0x1f;
  if (square == 0) {
    return 0;
  }
  uVar6 = 0x80000000;
  if (-1 < square) {
    do {
      uVar6 = (int)uVar6 >> 1;
      iVar4 = iVar4 + -1;
    } while ((uVar6 & square) == 0);
  }
  uVar5 = iVar4 >> 1;
  uVar6 = 1 << (uVar5 & 0x1f);
  iVar4 = 1 << ((uVar5 & 0xf) << 1);
  uVar7 = uVar6;
  iVar3 = iVar4;
  iVar1 = square - iVar4;
  while (uVar5 = uVar5 - 1, uVar5 != 0xffffffff) {
    uVar6 = (int)uVar6 >> 1;
    iVar4 = iVar4 >> 2;
    iVar2 = (iVar1 - iVar3) - iVar4;
    iVar3 = iVar3 >> 1;
    if (-1 < iVar2) {
      iVar3 = iVar3 + iVar4;
      uVar7 = uVar7 | uVar6;
      iVar1 = iVar2;
    }
  }
  return uVar7;
}



// decompiled code
// original method signature: 
// long /*$ra*/ MATH3D_DistanceBetweenPositions(struct _Position *pos1 /*$v0*/, struct _Position *pos2 /*$a1*/)
 // line 607, offset 0x80039e98
	/* begin block 1 */
		// Start line: 608
		// Start offset: 0x80039E98
	/* end block 1 */
	// End offset: 0x80039E98
	// End Line: 608

	/* begin block 2 */
		// Start line: 1208
	/* end block 2 */
	// End Line: 1209

/* File: C:\kain2\game\MATH3D.C */

long MATH3D_DistanceBetweenPositions(_Position *pos1,_Position *pos2)

{
  ulong square;
  long lVar1;
  
  square = MATH3D_SquareLength((int)pos2->x - (int)pos1->x,(int)pos2->y - (int)pos1->y,
                               (int)pos2->z - (int)pos1->z);
  lVar1 = MATH3D_FastSqrt0(square);
  return lVar1;
}



// decompiled code
// original method signature: 
// short /*$ra*/ MATH3D_AngleBetweenVectors(struct _SVector *vector1 /*$a0*/, struct _SVector *vector2 /*$a1*/)
 // line 616, offset 0x80039ee4
	/* begin block 1 */
		// Start line: 617
		// Start offset: 0x80039EE4
		// Variables:
	// 		long projection_length; // $s0
	/* end block 1 */
	// End offset: 0x80039FC0
	// End Line: 636

	/* begin block 2 */
		// Start line: 1098
	/* end block 2 */
	// End Line: 1099

/* File: C:\kain2\game\MATH3D.C */

short MATH3D_AngleBetweenVectors(_SVector *vector1,_SVector *vector2)

{
  long y;
  long x;
  int iVar1;
  
  iVar1 = (int)vector1->x * (int)vector2->x;
  if ((int)vector1->x == (int)vector2->x) {
    if ((vector1->y == vector2->y) && (vector1->z == vector2->z)) {
      return 0;
    }
    iVar1 = (int)vector1->x * (int)vector2->x;
  }
  x = iVar1 + (int)vector1->y * (int)vector2->y + (int)vector1->z * (int)vector2->z + 0x800 >> 0xc;
  if (x < 0x1001) {
    iVar1 = x * x;
    if (-0x1001 < x) goto LAB_80039f9c;
    x = -0x1000;
  }
  else {
    x = 0x1000;
  }
  iVar1 = x * x;
LAB_80039f9c:
  y = MATH3D_FastSqrt0(0x1000000 - iVar1);
  x = ratan2(y,x);
  return (short)x;
}



// decompiled code
// original method signature: 
// void /*$ra*/ MATH3D_RotMatAboutVec(struct _SVector *vec /*$s1*/, struct MATRIX *mat /*$s2*/, short angle /*$a2*/)
 // line 638, offset 0x80039fd0
	/* begin block 1 */
		// Start line: 639
		// Start offset: 0x80039FD0
		// Variables:
	// 		long length; // $s0
	// 		struct SVECTOR rot_angs; // stack offset -96
	// 		struct MATRIX mat1; // stack offset -88
	// 		struct MATRIX mat2; // stack offset -56
	/* end block 1 */
	// End offset: 0x8003A084
	// End Line: 657

	/* begin block 2 */
		// Start line: 1142
	/* end block 2 */
	// End Line: 1143

/* File: C:\kain2\game\MATH3D.C */

void MATH3D_RotMatAboutVec(_SVector *vec,undefined mat,short angle)

{
  ulong uVar1;
  long x;
  long lVar2;
  undefined3 in_register_00000015;
  MATRIX *m1;
  SVECTOR local_60;
  MATRIX MStack88;
  MATRIX MStack56;
  
  m1 = (MATRIX *)CONCAT31(in_register_00000015,mat);
  if ((int)angle != 0) {
    uVar1 = MATH3D_SquareLength(0,(int)vec->y,(int)vec->z);
    x = MATH3D_FastSqrt0(uVar1 + 0x800);
    lVar2 = ratan2((int)vec->y,(int)vec->z);
    local_60.vx = -(short)lVar2;
    x = ratan2((int)vec->x,x);
    local_60.vy = (short)x;
    local_60.vz = 0;
    RotMatrix(&local_60,&MStack88);
    TransposeMatrix(&MStack88,&MStack56);
    MulMatrix2(&MStack56,m1);
    RotMatrixZ((int)angle,m1);
    MulMatrix2(&MStack88,m1);
  }
  return;
}



// decompiled code
// original method signature: 
// void /*$ra*/ MATH3D_SetUnityMatrix(struct MATRIX *mat /*$a0*/)
 // line 659, offset 0x8003a0a0
	/* begin block 1 */
		// Start line: 1198
	/* end block 1 */
	// End Line: 1199

	/* begin block 2 */
		// Start line: 1199
	/* end block 2 */
	// End Line: 1200

/* File: C:\kain2\game\MATH3D.C */

void MATH3D_SetUnityMatrix(undefined mat)

{
  undefined3 in_register_00000011;
  undefined4 *puVar1;
  
  puVar1 = (undefined4 *)CONCAT31(in_register_00000011,mat);
  *puVar1 = 0x1000;
  puVar1[1] = 0;
  puVar1[2] = 0x1000;
  puVar1[3] = 0;
  *(undefined2 *)(puVar1 + 4) = 0x1000;
  return;
}



// decompiled code
// original method signature: 
// void /*$ra*/ AngleMoveToward(short *current_ptr /*$s3*/, short destination /*$a1*/, short step /*$a2*/)
 // line 675, offset 0x8003a0bc
	/* begin block 1 */
		// Start line: 676
		// Start offset: 0x8003A0BC
		// Variables:
	// 		long diff; // $a0
	// 		short current; // $s0
	/* end block 1 */
	// End offset: 0x8003A14C
	// End Line: 695

	/* begin block 2 */
		// Start line: 1230
	/* end block 2 */
	// End Line: 1231

/* File: C:\kain2\game\MATH3D.C */

void AngleMoveToward(short *current_ptr,short destination,short step)

{
  ushort current;
  short sVar1;
  int iVar2;
  int iVar3;
  
  current = *current_ptr;
  sVar1 = AngleDiff(current,destination);
  iVar3 = (int)sVar1;
  if (iVar3 == 0) {
LAB_8003a120:
    *current_ptr = destination;
    return;
  }
  iVar2 = iVar3;
  if (iVar3 < 0) {
    iVar2 = -iVar3;
  }
  if (iVar2 < step) goto LAB_8003a120;
  if (iVar3 < 1) {
    if (-1 < iVar3) goto LAB_8003a148;
    step = -step;
  }
  current = current + step;
LAB_8003a148:
  *current_ptr = current & 0xfff;
  return;
}



// decompiled code
// original method signature: 
// short /*$ra*/ AngleDiff(short current /*$a0*/, short destination /*$a1*/)
 // line 700, offset 0x8003a168
	/* begin block 1 */
		// Start line: 702
		// Start offset: 0x8003A168
	/* end block 1 */
	// End offset: 0x8003A180
	// End Line: 706

	/* begin block 2 */
		// Start line: 1284
	/* end block 2 */
	// End Line: 1285

	/* begin block 3 */
		// Start line: 1285
	/* end block 3 */
	// End Line: 1286

	/* begin block 4 */
		// Start line: 1287
	/* end block 4 */
	// End Line: 1288

/* File: C:\kain2\game\MATH3D.C */

short AngleDiff(short current,short destination)

{
  ushort uVar1;
  
  uVar1 = destination - current & 0xfff;
  if (0x800 < uVar1) {
    uVar1 = uVar1 | 0xf000;
  }
  return (short)uVar1;
}



// decompiled code
// original method signature: 
// short /*$ra*/ MATH3D_AngleFromPosToPos(struct _Position *from /*$a0*/, struct _Position *to /*$a1*/)
 // line 712, offset 0x8003a18c
	/* begin block 1 */
		// Start line: 713
		// Start offset: 0x8003A18C
	/* end block 1 */
	// End offset: 0x8003A18C
	// End Line: 713

	/* begin block 2 */
		// Start line: 1308
	/* end block 2 */
	// End Line: 1309

/* File: C:\kain2\game\MATH3D.C */

short MATH3D_AngleFromPosToPos(_Position *from,_Position *to)

{
  long lVar1;
  
  lVar1 = ratan2((int)from->y - (int)to->y,(int)from->x - (int)to->x);
  return (short)((short)lVar1 + 0xc00U & 0xfff);
}



// decompiled code
// original method signature: 
// void /*$ra*/ MATH3D_ZYXtoXYZ(struct _Rotation *rot /*$s0*/)
 // line 723, offset 0x8003a1c4
	/* begin block 1 */
		// Start line: 724
		// Start offset: 0x8003A1C4
		// Variables:
	// 		struct MATRIX tempMat; // stack offset -48
	// 		struct _G2EulerAngles_Type ea; // stack offset -16
	/* end block 1 */
	// End offset: 0x8003A1C4
	// End Line: 724

	/* begin block 2 */
		// Start line: 1331
	/* end block 2 */
	// End Line: 1332

/* File: C:\kain2\game\MATH3D.C */

void MATH3D_ZYXtoXYZ(_Rotation *rot)

{
  _G2Matrix_Type _Stack48;
  _G2EulerAngles_Type local_10;
  
  RotMatrixZYX((SVECTOR *)rot,(MATRIX *)&_Stack48);
  G2EulerAngles_FromMatrix(&local_10,&_Stack48,0x15);
  rot->x = local_10.x;
  rot->y = local_10.y;
  rot->z = local_10.z;
  return;
}



// decompiled code
// original method signature: 
// short /*$ra*/ MATH3D_ElevationFromPosToPos(struct _Position *from /*$s1*/, struct _Position *to /*$s0*/)
 // line 738, offset 0x8003a220
	/* begin block 1 */
		// Start line: 739
		// Start offset: 0x8003A220
	/* end block 1 */
	// End offset: 0x8003A220
	// End Line: 739

	/* begin block 2 */
		// Start line: 1361
	/* end block 2 */
	// End Line: 1362

/* File: C:\kain2\game\MATH3D.C */

short MATH3D_ElevationFromPosToPos(_Position *from,_Position *to)

{
  int iVar1;
  int iVar2;
  long lVar3;
  
  iVar1 = (int)from->x - (int)to->x;
  iVar2 = (int)from->y - (int)to->y;
  lVar3 = MATH3D_FastSqrt0(iVar1 * iVar1 + iVar2 * iVar2);
  lVar3 = ratan2((int)to->z - (int)from->z,(int)(short)lVar3);
  return (short)(-(short)lVar3 & 0xfff);
}



// decompiled code
// original method signature: 
// void /*$ra*/ MATH3D_RotationFromPosToPos(struct _Position *from /*$s0*/, struct _Position *to /*$s2*/, struct _Rotation *rot /*$s1*/)
 // line 754, offset 0x8003a2a4
	/* begin block 1 */
		// Start line: 1394
	/* end block 1 */
	// End Line: 1395

/* File: C:\kain2\game\MATH3D.C */

void MATH3D_RotationFromPosToPos(_Position *from,_Position *to,_Rotation *rot)

{
  short sVar1;
  
  sVar1 = MATH3D_ElevationFromPosToPos(from,to);
  rot->x = sVar1;
  rot->y = 0;
  sVar1 = MATH3D_AngleFromPosToPos(from,to);
  rot->z = sVar1;
  return;
}



// decompiled code
// original method signature: 
// int /*$ra*/ MATH3D_veclen2(int ix /*$v1*/, int iy /*$a1*/)
 // line 762, offset 0x8003a2f8
	/* begin block 1 */
		// Start line: 763
		// Start offset: 0x8003A2F8
		// Variables:
	// 		int t; // $a0
	/* end block 1 */
	// End offset: 0x8003A32C
	// End Line: 776

	/* begin block 2 */
		// Start line: 1412
	/* end block 2 */
	// End Line: 1413

/* File: C:\kain2\game\MATH3D.C */

int MATH3D_veclen2(int ix,int iy)

{
  bool bVar1;
  uint uVar2;
  
  if (ix < 0) {
    ix = -ix;
  }
  bVar1 = ix < iy;
  if (iy < 0) {
    iy = -iy;
    bVar1 = ix < iy;
  }
  if (bVar1) {
    uVar2 = ix ^ iy;
    iy = iy ^ uVar2;
    ix = uVar2 ^ iy;
  }
  iy = iy + (iy >> 1);
  return ((ix - (ix >> 5)) - (ix >> 7)) + (iy >> 2) + (iy >> 6);
}



// decompiled code
// original method signature: 
// void /*$ra*/ MATH3D_RotateAxisToVector(struct MATRIX *dest /*$s3*/, struct MATRIX *src /*$s2*/, struct _SVector *vec /*$a2*/, enum MATH3D_AXIS axis /*$a3*/)
 // line 784, offset 0x8003a358
	/* begin block 1 */
		// Start line: 785
		// Start offset: 0x8003A358
		// Variables:
	// 		struct MATRIX xform; // stack offset -64
	// 		struct _G2Quat_Type rot; // stack offset -32
	// 		long len; // $s0
	// 		int theta; // $s1
	// 		int sintheta; // $v0
	// 		int px; // $a3
	// 		int py; // $v1
	// 		int pz; // $a1
	/* end block 1 */
	// End offset: 0x8003A4F8
	// End Line: 820

	/* begin block 2 */
		// Start line: 1456
	/* end block 2 */
	// End Line: 1457

/* File: C:\kain2\game\MATH3D.C */

void MATH3D_RotateAxisToVector(undefined dest,undefined src,_SVector *vec,MATH3D_AXIS axis)

{
  short *psVar1;
  int iVar2;
  int a;
  ulong square;
  int iVar3;
  undefined3 in_register_00000011;
  undefined3 in_register_00000015;
  MATRIX *m0;
  int iVar4;
  long lVar5;
  MATRIX MStack64;
  short local_20;
  short local_1e;
  short local_1c;
  undefined2 local_1a;
  
  m0 = (MATRIX *)CONCAT31(in_register_00000015,src);
  if (axis < AXIS_NEG_X) {
    psVar1 = m0->m + axis;
    a = (int)*psVar1;
    iVar3 = (int)psVar1[3];
    iVar4 = (int)psVar1[6];
  }
  else {
    psVar1 = m0->m + axis + ~AXIS_Z;
    a = -(int)*psVar1;
    iVar3 = -(int)psVar1[3];
    iVar4 = -(int)psVar1[6];
  }
  iVar2 = iVar3 * vec->z - iVar4 * vec->y;
  if (iVar2 < 0) {
    iVar2 = iVar2 + 0xfff;
  }
  local_20 = (short)(iVar2 >> 0xc);
  iVar2 = iVar4 * vec->x - a * vec->z;
  if (iVar2 < 0) {
    iVar2 = iVar2 + 0xfff;
  }
  local_1e = (short)(iVar2 >> 0xc);
  iVar2 = a * vec->y - iVar3 * vec->x;
  if (iVar2 < 0) {
    iVar2 = iVar2 + 0xfff;
  }
  local_1c = (short)(iVar2 >> 0xc);
  a = a * vec->x + iVar3 * vec->y + iVar4 * vec->z;
  if (a < 0) {
    a = a + 0xfff;
  }
  a = MATH3D_racos_S(a >> 0xc);
  a = ((a << 0x10) >> 0x10) - ((a << 0x10) >> 0x1f) >> 1;
  square = MATH3D_SquareLength((int)local_20,(int)local_1e,(int)local_1c);
  if ((int)square < 1) {
    lVar5 = 0x1000;
  }
  else {
    lVar5 = MATH3D_FastSqrt0(square);
  }
  iVar3 = rsin(a);
  local_20 = (short)((local_20 * iVar3) / lVar5);
  local_1e = (short)((local_1e * iVar3) / lVar5);
  local_1c = (short)((local_1c * iVar3) / lVar5);
  a = rcos(a);
  local_1a = (undefined2)a;
  G2Quat_ToMatrix_S(&local_20,(short *)&MStack64);
  MulMatrix0(m0,&MStack64,(MATRIX *)CONCAT31(in_register_00000011,dest));
  return;
}



// decompiled code
// original method signature: 
// int /*$ra*/ MATH3D_ConeDetect(struct _SVector *pos /*$s2*/, int arc /*$s0*/, int elevation /*$s4*/)
 // line 859, offset 0x8003a5b0
	/* begin block 1 */
		// Start line: 860
		// Start offset: 0x8003A5B0
		// Variables:
	// 		long y; // $s1
	// 		long x; // $s3

		/* begin block 1.1 */
			// Start line: 866
			// Start offset: 0x8003A60C
		/* end block 1.1 */
		// End offset: 0x8003A644
		// End Line: 872
	/* end block 1 */
	// End offset: 0x8003A648
	// End Line: 874

	/* begin block 2 */
		// Start line: 1709
	/* end block 2 */
	// End Line: 1710

/* File: C:\kain2\game\MATH3D.C */

int MATH3D_ConeDetect(_SVector *pos,int arc,int elevation)

{
  short sVar1;
  short sVar2;
  long x;
  int y;
  int x_00;
  
  x_00 = (int)pos->x;
  sVar2 = pos->y;
  y = x_00;
  if (x_00 < 0) {
    y = -x_00;
  }
  sVar1 = MATH3D_FastAtan2(y,-(int)sVar2);
  if (sVar1 < arc) {
    x = MATH3D_LengthXY(x_00,-(int)sVar2);
    y = (int)pos->z;
    if (y < 0) {
      y = -y;
    }
    sVar2 = MATH3D_FastAtan2(y,x);
    if (sVar2 < elevation) {
      return 1;
    }
  }
  return 0;
}



// decompiled code
// original method signature: 
// void /*$ra*/ MATH3D_CrossProduct(struct _SVector *t /*$a0*/, struct _SVector *r /*$a1*/, struct _SVector *s /*$a2*/)
 // line 976, offset 0x8003a668
	/* begin block 1 */
		// Start line: 1950
	/* end block 1 */
	// End Line: 1951

	/* begin block 2 */
		// Start line: 1728
	/* end block 2 */
	// End Line: 1729

/* File: C:\kain2\game\MATH3D.C */

void MATH3D_CrossProduct(_SVector *t,_SVector *r,_SVector *s)

{
  t->x = (short)((int)r->y * (int)s->z - (int)r->z * (int)s->y >> 0xc);
  t->y = -(short)((int)r->x * (int)s->z - (int)r->z * (int)s->x >> 0xc);
  t->z = (short)((int)r->x * (int)s->y - (int)r->y * (int)s->x >> 0xc);
  return;
}



// decompiled code
// original method signature: 
// unsigned long /*$ra*/ MATH3D_SquareLength(long x /*$v0*/, long y /*$a1*/, long z /*$a2*/)
 // line 989, offset 0x8003a70c
	/* begin block 1 */
		// Start line: 1748
	/* end block 1 */
	// End Line: 1749

/* File: C:\kain2\game\MATH3D.C */

ulong MATH3D_SquareLength(long x,long y,long z)

{
  int iVar1;
  int iVar2;
  int iVar3;
  
  setCopReg(2,0x4800,x);
  setCopReg(2,0x5000,y);
  setCopReg(2,0x5800,z);
  copFunction(2,0xa00428);
  iVar1 = getCopReg(2,0xc800);
  iVar2 = getCopReg(2,0xd000);
  iVar3 = getCopReg(2,0xd800);
  return iVar1 + iVar2 + iVar3;
}





